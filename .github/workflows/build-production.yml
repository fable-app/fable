name: Production Build

on:
  push:
    branches: [main]
    tags: ['v*']
  workflow_dispatch:

jobs:
  build-android:
    name: Build Android Production
    runs-on: ubuntu-latest
    outputs:
      build-id: ${{ steps.build.outputs.build-id }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Expo and EAS
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install workspace dependencies
        run: npm install --legacy-peer-deps

      - name: Build Android production
        id: build
        working-directory: apps/mobile
        run: |
          BUILD_OUTPUT=$(eas build --platform android --profile production --non-interactive --json)
          BUILD_ID=$(echo $BUILD_OUTPUT | jq -r '.[0].id')
          echo "build-id=$BUILD_ID" >> $GITHUB_OUTPUT
          echo "Build ID: $BUILD_ID"

      - name: Upload build artifact info
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: android-build-info
          path: |
            apps/mobile/eas-build-*.json
          retention-days: 30

  submit-android:
    name: Submit to Google Play Store
    runs-on: ubuntu-latest
    needs: build-android
    if: success()
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Expo and EAS
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install workspace dependencies
        run: npm install --legacy-peer-deps

      - name: Create service account key file
        working-directory: apps/mobile
        run: |
          mkdir -p secrets
          echo '${{ secrets.GOOGLE_SERVICE_ACCOUNT_KEY }}' > secrets/play-store-credentials.json

      - name: Submit to Google Play Store
        working-directory: apps/mobile
        run: |
          eas submit --platform android --latest --non-interactive
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}

      - name: Clean up credentials
        if: always()
        working-directory: apps/mobile
        run: |
          rm -rf secrets/

  build-ios:
    name: Build iOS Production
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup Expo and EAS
        uses: expo/expo-github-action@v8
        with:
          expo-version: latest
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}

      - name: Install workspace dependencies
        run: npm install --legacy-peer-deps

      - name: Build iOS production
        working-directory: apps/mobile
        run: eas build --platform ios --profile production --non-interactive

      - name: Upload build artifact info
        uses: actions/upload-artifact@v4
        if: success()
        with:
          name: ios-build-info
          path: |
            apps/mobile/eas-build-*.json
          retention-days: 30

  notify:
    name: Notify Deployment Status
    runs-on: ubuntu-latest
    needs: [build-android, submit-android, build-ios]
    if: always()
    steps:
      - name: Check deployment status
        run: |
          echo "Build and Deployment Status:"
          echo "- Android Build: ${{ needs.build-android.result }}"
          echo "- Android Submit: ${{ needs.submit-android.result }}"
          echo "- iOS Build: ${{ needs.build-ios.result }}"

          if [ "${{ needs.build-android.result }}" == "success" ] && [ "${{ needs.submit-android.result }}" == "success" ]; then
            echo "✅ Android deployed to Google Play Store successfully!"
          else
            echo "❌ Android deployment failed."
          fi

          if [ "${{ needs.build-ios.result }}" == "success" ]; then
            echo "✅ iOS build completed successfully!"
          else
            echo "❌ iOS build failed."
          fi
